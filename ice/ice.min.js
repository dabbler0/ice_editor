(function(){var e,t,n,r,i,o,p,a,l,s={}.hasOwnProperty,c=function(e,t){for(var n in t){if(s.call(t,n))e[n]=t[n]}function r(){this.constructor=e}r.prototype=t.prototype;e.prototype=new r;e.__super__=t.prototype;return e};l=function(e,t){console.log(t.droppable);if(e.parent!=null){if(e.parent.type==="block"){e.parent.children.splice(e.parent.children.indexOf(e),1);e.parent.droppable=true}else{e.parent.children.length=0;e.parent.droppable=true}}if(t.type==="block"){t.children.unshift(e);t.droppable=e.droppable=true;return e.parent=t}else if(t.type==="statement"){t.parent.children.splice(t.parent.children.indexOf(t)+1,0,e);t.droppable=e.droppable=true;return e.parent=t.parent}else if(t.type==="inline"){t.children=[e];t.droppable=e.droppable=false;return e.parent=t}};r=function(){function e(){this.parent=null;this.index=0;this.children=[];this.type=null}e.prototype._reconstruct=function(){return new e};e.prototype.stringify=function(){var e,t,n,r,i;t="";i=this.children;for(n=0,r=i.length;n<r;n++){e=i[n];if(typeof e==="string"){t+=e}else{t+=e.stringify()}}return t};e.prototype.clone=function(){var e,t,n,r,i,o;n=this._reconstruct();n.type=this.type;n.children=[];o=this.children;for(r=0,i=o.length;r<i;r++){e=o[r];if(typeof e==="string"){n.children.push(e)}else{t=e.clone();t.parent=n;n.children.push(t)}}if(this.droppable!=null){n.droppable=this.droppable}return n};e.prototype.templateify=function(){var e,t,n;e=this.blockify();n=this;t=null;e.on("dragstart",function(){var r;r=n.clone();t=r.templateify();t.hide();e.after(t);return e.unbind("dragstart")});return e.on("dragstop",function(){if(n.parent!=null){t.show();return e.unbind("dragstop")}})};return e}();o=function(e){c(t,e);function t(e){this.parent=null;this.index=0;this.children=[e];this.type="static"}t.prototype._reconstruct=function(){return new t};t.prototype.blockify=function(){var e,t,n,r,i;e=$("<span>");e.addClass("ice_segment");e.addClass("ice_"+this.type);i=this.children;for(n=0,r=i.length;n<r;n++){t=i[n];if(typeof t==="string"){e.append(t)}else{e.append(t.blockify())}}return e};return t}(r);n=function(e){c(t,e);function t(e){this.parent=null;this.index=0;this.children=[];this.type="inline";this.accept=e;this.droppable=true}t.prototype._reconstruct=function(){return new t(this.accept)};t.prototype.blockify=function(){var e,t,n,r,i,o,p;r=this;e=$("<span>");e.addClass("ice_segment");e.addClass("ice_"+this.type);p=this.children;for(i=0,o=p.length;i<o;i++){t=p[i];if(typeof t==="string"){e.append(t)}else{e.append(t.blockify())}}e.data("ice_tree",r);n=$("<input>");n.addClass("ice_input");n.keyup(function(){if(r.droppable){return r.children[0]=this.value}});e.append(n);n.autoGrowInput({comfortZone:0,minWidth:20,maxWidth:Infinity});e.droppable({greedy:true,tolerance:"pointer",hoverClass:"highlight",accept:function(e){return r.droppable&&r.accept(e.data("ice_tree"))},drop:function(e,t){if(e.target===this){n.val("");l(t.draggable.data("ice_tree"),r);return $(this).prepend(t.draggable)}}});return e};return t}(r);e=function(e){c(t,e);function t(){this.parent=null;this.index=0;this.children=[];this.type="block";this.droppable=true}t.prototype._reconstruct=function(){return new t};t.prototype.stringify=function(){var e;console.log("Blockifying",this.children);return"  "+function(){var t,n,r,i;r=this.children;i=[];for(t=0,n=r.length;t<n;t++){e=r[t];i.push(e.stringify())}return i}.call(this).join("\n").replace(/\n/g,"\n  ")};t.prototype.blockify=function(){var e,t,n,r,i,o,p;r=this;e=$("<div>");e.addClass("ice_segment");e.addClass("ice_"+this.type);p=this.children;for(i=0,o=p.length;i<o;i++){t=p[i];if(typeof t==="string"){e.append(t)}else{e.append($("<div>").append(t.blockify()))}}n=$("<div>");n.addClass("ice_block_drop_target");n.droppable({greedy:true,tolerance:"pointer",hoverClass:"highlight",accept:function(){return r.droppable},drop:function(t,n){if(t.target===this){l(n.draggable.data("ice_tree"),r);return e.prepend($("<div>").append(n.draggable))}}});e.append(n);return e};return t}(r);i=function(e){c(t,e);function t(e){var t,n,r;this.parent=null;this.children=[];for(n=0,r=e.length;n<r;n++){t=e[n];this.children.push(t.clone())}this.type="statement";this.droppable=true}t.prototype._reconstruct=function(){return new t([])};t.prototype.blockify=function(){var e,t,n,r,i,o,p;r=this;e=$("<div>");e.addClass("ice_segment");e.addClass("ice_"+this.type);p=this.children;for(i=0,o=p.length;i<o;i++){t=p[i];if(typeof t==="string"){e.append(t)}else{e.append(t.blockify())}}e.data("ice_tree",r);n=$("<div>");n.addClass("ice_drop_target");n.droppable({greedy:true,tolerance:"pointer",hoverClass:"highlight",accept:function(){return r.droppable},drop:function(t,n){if(t.target===this){l(n.draggable.data("ice_tree"),r);return e.after($("<div>").append(n.draggable))}}});e.append(n);e.draggable({appendTo:"body",helper:"clone",revert:"invalid"});return e};return t}(r);t=function(){function t(t,n){var r,i,o;this.element=$(t);this.palette=$("<div>");this.palette.addClass("ice_palette blockish");for(i=0,o=n.length;i<o;i++){r=n[i];this.palette.append($("<div>").append(r.templateify()))}this.workspace=$("<div>");this.workspace.addClass("ice_workspace blockish");this.root=new e;this.workspace.append(this.root.blockify());this.element.append(this.palette).append(this.workspace)}t.prototype.getValue=function(){return this.root.stringify()};return t}();a=function(t,r){var p,a,l,s,c,d,u,h,f;u=new i([]);s="";c=false;for(h=0,f=t.length;h<f;h++){a=t[h];if(c){if(a==="%"){s+="%"}else if(a==="w"){u.children.push(new o(s));p=r.shift();l=p!=null?p.clone():new e;l.parent=u;u.children.push(l);s=""}else{u.children.push(new o(s));d=new n(function(){return true});p=r.shift();if(p!=null){p.parent=d;d.children.push(p);p.droppable=false;d.droppable=false}u.children.push(d);s=""}c=false}else{if(a==="%"){c=true}else{s+=a}}}u.children.push(new o(s));return u};p=function(t){var n,r,l,s,c,d,u,h,f,g,y;if(t.constructor.name==="Block"){s=new e;g=t.expressions;for(d=0,h=g.length;d<h;d++){l=g[d];r=p(l);r.parent=s;s.children.push(r)}return s}else if(t.constructor.name==="Value"){return p(t.base)}else if(t.constructor.name==="Literal"){return new i([new o(t.value)])}else if(t.constructor.name==="Call"){y=t.args;for(u=0,f=y.length;u<f;u++){n=y[u];return a("%v("+[function(){var e,r,i,o;i=t.args;o=[];for(e=0,r=i.length;e<r;e++){n=i[e];o.push("%v")}return o}()].join(",")+")",[p(t.variable)].concat(p(n)))}}else if(t.constructor.name==="Code"){return a("("+[function(){var e,n,r,i;r=t.params;i=[];for(e=0,n=r.length;e<n;e++){c=r[e];i.push("%v")}return i}()].join(",")+") ->\n%w",function(){var e,n,r,i;r=t.params;i=[];for(e=0,n=r.length;e<n;e++){c=r[e];i.push(p(c))}return i}().concat([p(t.body)]))}};window.blockify=p;window.onload=function(){var e,n,r,i;e=a("(%v + %v)",[null,null]);r=a("(%v * %v)",[null,null]);i=p(CoffeeScript.nodes("->\n  a b")).children[0];i.parent=null;n=new t(document.getElementById("editor"),[e,r,i]);return window.editor=n}}).call(this);
